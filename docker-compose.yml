services:
  zeek:
    image: blacktop/zeek:latest
    container_name: soc-zeek
    user: root
    volumes:
      - ./data/raw:/pcap:ro
      - ./data/derived/zeek:/logs:rw
      - ./configs/zeek:/usr/local/zeek/share/zeek/site:ro
    environment:
      - PCAP_FILE=${PCAP_FILE:-}
      - ZEEK_LOG_PATH=/logs
    command: >
      sh -c "
        if [ -z \"$$PCAP_FILE\" ]; then
          echo 'Error: PCAP_FILE environment variable not set';
          exit 1;
        fi;
        if [ ! -f \"/pcap/$$PCAP_FILE\" ]; then
          echo \"Error: PCAP file /pcap/$$PCAP_FILE not found\";
          exit 1;
        fi;
        echo \"Processing PCAP: /pcap/$$PCAP_FILE\";
        cd /logs && zeek -r \"/pcap/$$PCAP_FILE\" -C local LogAscii::use_json=T LogAscii::json_timestamps=JSON::TS_EPOCH 2>&1;
        if [ -f \"/logs/conn.log\" ]; then
          LINE_COUNT=$$(wc -l < /logs/conn.log 2>/dev/null || echo 0);
          echo \"✓ Generated conn.log ($$LINE_COUNT lines)\";
        else
          echo \"⚠️  conn.log not generated\";
        fi;
        if [ -f \"/logs/dns.log\" ]; then
          LINE_COUNT=$$(wc -l < /logs/dns.log 2>/dev/null || echo 0);
          echo \"✓ Generated dns.log ($$LINE_COUNT lines)\";
        fi;
        echo 'Zeek processing completed';
      "
    networks:
      - soc-network
    restart: "no"

  suricata:
    image: jasonish/suricata:latest
    container_name: soc-suricata
    user: root
    volumes:
      - ./data/raw:/pcap:ro
      - ./data/derived/suricata:/var/log/suricata:rw
      - ./configs/suricata:/etc/suricata:ro
    environment:
      - PCAP_FILE=${PCAP_FILE:-}
    command: >
      sh -c "
        if [ -z \"$$PCAP_FILE\" ]; then
          echo 'Error: PCAP_FILE environment variable not set';
          exit 1;
        fi;
        if [ ! -f \"/pcap/$$PCAP_FILE\" ]; then
          echo \"Error: PCAP file /pcap/$$PCAP_FILE not found\";
          exit 1;
        fi;
        echo \"Processing PCAP: /pcap/$$PCAP_FILE\";
        suricata -r \"/pcap/$$PCAP_FILE\" -l /var/log/suricata -c /etc/suricata/suricata.yaml 2>&1;
        if [ -f \"/var/log/suricata/eve.json\" ]; then
          LINE_COUNT=$$(wc -l < /var/log/suricata/eve.json 2>/dev/null || echo 0);
          echo \"✓ Generated eve.json ($$LINE_COUNT lines)\";
        else
          echo \"⚠️  eve.json not generated\";
        fi;
        echo 'Suricata processing completed';
      "
    networks:
      - soc-network
    restart: "no"

  pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: soc-pipeline
    user: root
    volumes:
      - ./data:/app/data:rw
      - ./reports:/app/reports:rw
      - ./configs:/app/configs:ro
      - ./src:/app/src:ro
    environment:
      - PCAP_FILE=${PCAP_FILE:-}
      - RUN_TIMESTAMP=${RUN_TIMESTAMP:-}
    command: python -m src.main --pcap /app/data/raw/$${PCAP_FILE}
    networks:
      - soc-network
    depends_on:
      - zeek
      - suricata
    restart: "no"

networks:
  soc-network:
    driver: bridge
